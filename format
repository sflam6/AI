#!/bin/bash

pacman -S parted --noconfirm -needed

# Check user privilege
if [ $(whoami) != "root" ]; then
  echo "Please run this script with root privileges!"
  exit 1
fi

# Check for disk argument
if [ $# -ne 2 ]; then
  echo "Please specify the disk to format and desired swap size!"
  echo "Usage: $0 /dev/sdX <swap_size_in_GiB>"
  exit 1
fi

disk=$1
swap_size=$2

# Check if disk exists
if [ ! -block "$disk" ]; then
  echo "Disk $disk does not exist!"
  exit 1
fi

# Check disk size
size=$(fdisk -s $disk)

# Create GPT partition table
parted $disk << EOF
mklabel gpt
mkpart efi fat32 1 512mb
set 1 boot on
mkpart swap linux-swap 512mb 512mb+($swap_size)gb
set 2 swap on
mkpart Linux ext4 513mb+($swap_size)gb 100%
EOF

# Calculate remaining space for data partition after swap
data_start=$(($size - $(($swap_size * 1024)) * 1024 * 1024))

# Create swap partition with specified size
parted $disk << EOF
mkpart swap linux-swap 512MiB $data_start
set 2 swap on
EOF

# Create Linux data partition with remaining space
parted $disk << EOF
mkpart Linux ext4 $($data_start + 1) 100%
set 3 linux-home on
EOF

echo "Disk $disk formatted successfully!"
